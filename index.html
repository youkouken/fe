<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FE Quest (Soft UI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>


    <div class="modal-overlay" id="mode-modal">
        <div class="modal-box">
            <div class="modal-title" id="lbl-mode-title"></div>
            <button class="mode-btn" id="btn-mode-10" onclick="confirmStart(10)"></button>
            <button class="mode-btn" id="btn-mode-20" onclick="confirmStart(20)"></button>
            <button class="mode-btn" id="btn-mode-30" onclick="confirmStart(30)"></button>
            <button class="mode-btn secondary" id="btn-mode-all" onclick="confirmStart('all')"></button>
            <div style="margin-top:15px; opacity:0.6; cursor:pointer;" id="lbl-cancel" onclick="closeModal()"></div>
        </div>
    </div>

    <div class="modal-overlay" id="msg-modal" onclick="closePopup()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title" id="msg-content" style="margin-bottom: 20px; line-height: 1.5; white-space: pre-line;"></div>
            <button class="mode-btn" id="btn-msg-ok" onclick="closePopup()"></button>
        </div>
    </div>

    <div id="lobby-screen" class="screen" style="display: flex;">
        
        <div class="header-capsule">
            <div class="user-trigger" style="cursor: default;">
                <div id="guest-avatar" class="avatar-placeholder">ğŸ‘¤</div>
            </div>
            
            <div style="flex:1;"></div> 

            <button class="header-action-btn" onclick="toggleTheme()">ğŸ¨</button>
        </div>

        <div class="content-area">
            <h2 id="lbl-app-title" style="text-align:center; color:var(--text-color); opacity:0.8; margin-bottom:20px;"></h2>
            <div class="chapter-list" id="chapter-list"></div>
        </div>

        <div class="footer-stats">
            <button class="stat-pill" onclick="startBookmarkSession()">
                <span style="color:#f1c40f;">â˜…</span> 
                <span id="bookmark-count" style="margin-left:5px;">0</span>
            </button>
            
            <button class="stat-pill" onclick="showMasteredScreen()">
                <span style="color:#e67e22;">ğŸ†</span> 
                <span id="mastered-count" style="margin-left:5px;">0</span>
            </button>
        </div>
        
        <div style="text-align: center; margin-bottom: 10px;">
             <button id="btn-reset" onclick="resetProgress()" style="background:none; border:none; color:var(--text-color); opacity:0.3; font-size:0.8rem; cursor:pointer;">Reset</button>
        </div>
    </div>

    <div id="study-screen" class="screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goBackToLobby()">âœ•</button>
            <div class="progress-pill">
                <span id="lbl-remain"></span> <span id="remain-count">0</span>
            </div>
        </div>
        
        <div class="card-area">
            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="card-face card-front">
                    <div class="card-icon" id="bookmark-icon" onclick="toggleBookmark(event)">â˜…</div>
                    <div class="status-dot" id="debt-badge"></div>
                    
                    <div class="content-block">
                        <div class="lang-tag">ä¸­æ–‡</div>
                        <div class="term-main" id="term-zh">---</div>
                    </div>
                    <div class="divider-line"></div>
                    <div class="content-block">
                        <div class="lang-tag">æ—¥èª</div>
                        <div class="term-main" id="term-ja" style="color: var(--accent-pink);">---</div>
                        <div class="term-sub" id="term-yomi">---</div>
                        <div class="term-eng" id="term-eng">---</div>
                    </div>
                    <div style="margin-top:auto; opacity:0.4; font-size: 0.85rem;" id="lbl-tap">æŒ‰</div>
                </div>
                <div class="card-face card-back">
                    <div class="content-block"><div class="lang-tag">æ„å‘³</div><div class="desc-text" id="desc-zh">---</div></div>
                    <div class="divider-line"></div>
                    <div class="content-block"><div class="lang-tag">è§£èª¬</div><div class="desc-text" id="desc-ja">---</div></div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <button class="action-btn fuzzy" id="btn-fuzzy" onclick="handleBlurry()">æ¨¡ç³Š</button>
            <button class="action-btn know" id="btn-know" onclick="handleKnow()">èªè­˜</button>
            <button class="action-btn master" id="btn-master" onclick="handleMastered()">æŒæ¡</button>
        </div>
    </div>

    <div id="mastered-screen" class="screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goBackToLobby()">â—€</button>
            <span style="font-weight:bold; color:var(--text-color);" id="lbl-list-title"></span>
        </div>
        <div class="chapter-list" id="mastered-list" style="padding-top:20px;"></div>
    </div>

    <script src="questions.js"></script>

    <script>
        // --- 1. æ–‡å­—æ¨™ç±¤ (Labels) ---
        const labels = {
            appTitle: "ğŸŒ¸ å°è«¾çš„åŸºæœ¬æƒ…å ±è©¦é©—",
            buttons: {
                themeSwitch: "<>",
                bookmark: "æ”¶è—",
                mastered: "å·²æŒæ¡",
                reset: "é‡ç½®æ‰€æœ‰é€²åº¦",
                close: "âœ• çµæŸ",
                back: "â—€ è¿”å›",
                cancel: "âœ• å–æ¶ˆ",
                forget: "å¿˜è¨˜",
                fuzzy: "æ¨¡ç³Š",
                know: "èªè­˜",
                master: "å·²æŒæ¡",
                ok: "ğŸ‘Œ çŸ¥é“äº†",
                mode10: " 10 é¡Œ (å¿«é€Ÿ)",
                mode20: " 20 é¡Œ (æ¨™æº–)",
                mode30: " 30 é¡Œ (æŒ‘æˆ°)",
                modeAll: "ğŸ“š å…¨éƒ¨è¤‡ç¿’"
            },
            status: {
                remaining: "å‰©é¤˜",
                unit: "å¼µ",
                reviewNeeded: "éœ€è¤‡ç¿’",
                tapToFlip: "ç¿»é ",
                emptyMastered: "ç›®å‰æ²’æœ‰å·²æŒæ¡çš„å¡ç‰‡",
                emptyBookmark: "æ”¶è—å¤¾æ˜¯ç©ºçš„",
                allClear: "ğŸ‰ å…¨éƒ¨å®Œæˆ",
                remainingCount: "å‰©é¤˜ {n} é¡Œ"
            },
            messages: {
                confirmReset: "ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é€²åº¦å—ï¼Ÿ",
                confirmUnMaster: "ç¢ºå®šå°‡æ­¤å¡ç‰‡ç§»å›å­¸ç¿’å€å—ï¼Ÿ",
                movedBack: "å·²ç§»å›",
                complete: "æœ¬è¼ªç·´ç¿’çµæŸ âœ¨",
                markFuzzy: "æ¨™è¨˜æ¨¡ç³Š (å‰© {n} æ¬¡)",
                markClear: "å·²æ¶ˆé™¤æ¨¡ç³Šç‹€æ…‹ï¼",
                keepGoing: "é‚„éœ€ç­”å° {n} æ¬¡",
                pass: "Pass! âœ¨",
                addedMaster: "å·²åŠ å…¥æŒæ¡æ¸…å–® ğŸ†",
                addedBookmark: "å·²æ”¶è— â¤ï¸",
                removedBookmark: "å·²å–æ¶ˆæ”¶è—",
                chapterComplete: "æ­¤ç« ç¯€å·²å…¨éƒ¨æŒæ¡ï¼è¦é€²è¡Œç¸½è¤‡ç¿’å—ï¼Ÿ",
                selectModeTitle: "âœ¨ é¸æ“‡é¡Œæ•¸",
                masteredListTitle: "å·²æŒæ¡æ¸…å–®"
            }
        };

        // --- 2. ç‹€æ…‹è®Šæ•¸ ---
        let sessionDeck = []; 
        let currentCard = null;
        let sessionDebt = {}; 
        let masteredIds = JSON.parse(localStorage.getItem('fe_mastered')) || [];
        let bookmarkedIds = JSON.parse(localStorage.getItem('fe_bookmarked')) || [];
        let selectedCategory = null; 

        // --- 3. åˆå§‹åŒ– ---
        function init() { 
            // è®€å–ä¸»é¡Œ
            const savedTheme = localStorage.getItem('fe_theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            }

            // åˆå§‹åŒ–ä»‹é¢æ–‡å­—
            initLabels(); 
            
            // æª¢æŸ¥é¡Œåº«æ˜¯å¦è¼‰å…¥
            if(typeof questionData === 'undefined' || questionData.length === 0) {
                showPopup("éŒ¯èª¤ï¼šç„¡æ³•è®€å– questions.js\nè«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨ä¸”ç¬¬ä¸€è¡Œå·²ç§»é™¤ export");
                return;
            }
            
            renderLobby();
        }

        function initLabels() {
            document.title = labels.appTitle;
            document.getElementById('lbl-app-title').innerText = labels.appTitle;
            
            // å½ˆçª—
            document.getElementById('lbl-mode-title').innerText = labels.messages.selectModeTitle;
            document.getElementById('btn-mode-10').innerText = labels.buttons.mode10;
            document.getElementById('btn-mode-20').innerText = labels.buttons.mode20;
            document.getElementById('btn-mode-30').innerText = labels.buttons.mode30;
            document.getElementById('btn-mode-all').innerText = labels.buttons.modeAll;
            document.getElementById('lbl-cancel').innerText = labels.buttons.cancel;
            document.getElementById('btn-msg-ok').innerText = labels.buttons.ok;

            // å­¸ç¿’ä»‹é¢
            document.getElementById('lbl-remain').innerText = labels.status.remaining;
            document.getElementById('lbl-tap').innerText = labels.status.tapToFlip;
            document.getElementById('btn-reset').innerText = labels.buttons.reset;
            document.getElementById('lbl-list-title').innerText = labels.messages.masteredListTitle;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }

        function renderLobby() {
            const listEl = document.getElementById('chapter-list');
            listEl.innerHTML = "";
            const categories = [...new Set(questionData.map(item => item.cat))];

            categories.forEach(cat => {
                const itemsInCat = questionData.filter(i => i.cat === cat);
                const remaining = itemsInCat.filter(i => !masteredIds.includes(i.id)).length;
                const statusText = remaining === 0 ? labels.status.allClear : labels.status.remainingCount.replace('{n}', remaining);

                const div = document.createElement('div');
                div.className = 'chapter-card';
                div.onclick = () => openModeModal(cat);
                div.innerHTML = `
                    <div>
                        <div style="font-weight:700; font-size:1.1rem; margin-bottom:5px;">${cat}</div>
                        <span class="tag-pill">${statusText}</span>
                    </div>
                    <div style="font-size:1.2rem;">â–¶</div>
                `;
                listEl.appendChild(div);
            });
            document.getElementById('bookmark-count').innerText = bookmarkedIds.length;
            document.getElementById('mastered-count').innerText = masteredIds.length;
        }

        // --- æŒ‰éˆ•åŠŸèƒ½ ---
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('fe_theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('fe_theme', 'dark');
            }
        }

        function openModeModal(category) {
            selectedCategory = category;
            const pool = questionData.filter(item => item.cat === category && !masteredIds.includes(item.id));
            if (pool.length === 0) {
                if(confirm(labels.messages.chapterComplete)) document.getElementById('mode-modal').style.display = 'flex';
            } else {
                document.getElementById('mode-modal').style.display = 'flex';
            }
        }

        function closeModal() { document.getElementById('mode-modal').style.display = 'none'; selectedCategory = null; }

        function confirmStart(count) {
            let pool = questionData.filter(item => item.cat === selectedCategory && !masteredIds.includes(item.id));
            if (pool.length === 0) pool = questionData.filter(item => item.cat === selectedCategory);
            closeModal();
            
            for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pool[i], pool[j]] = [pool[j], pool[i]]; }
            sessionDeck = (count !== 'all') ? pool.slice(0, count) : pool;
            sessionDebt = {}; 
            showScreen('study-screen');
            pickRandomCard();
        }

        function startBookmarkSession() {
            sessionDeck = questionData.filter(item => bookmarkedIds.includes(item.id));
            if (sessionDeck.length === 0) { showPopup(labels.status.emptyBookmark); return; }
            sessionDebt = {};
            showScreen('study-screen');
            pickRandomCard();
        }

        function showMasteredScreen() {
            const list = document.getElementById('mastered-list');
            list.innerHTML = "";
            const masteredItems = questionData.filter(item => masteredIds.includes(item.id));
            if(masteredItems.length === 0) {
                list.innerHTML = `<div style='text-align:center; padding:20px; opacity:0.5;'>${labels.status.emptyMastered}</div>`;
            } else {
                masteredItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<div><div style="font-weight:bold;">${item.zh}</div><div style="font-size:0.8rem; opacity:0.7;">${item.ja}</div></div><button class="list-btn" onclick="unMaster(${item.id})">${labels.buttons.forget}</button>`;
                    list.appendChild(div);
                });
            }
            showScreen('mastered-screen');
        }

        function goBackToLobby() { showScreen('lobby-screen'); renderLobby(); }
        function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); }

        function handleBlurry() {
            const id = currentCard.id;
            sessionDebt[id] = (sessionDebt[id] || 0) + 1;
            showPopup(labels.messages.markFuzzy.replace('{n}', sessionDebt[id]));
            pickRandomCard();
        }

        function handleKnow() {
            const id = currentCard.id;
            if (sessionDebt[id] > 0) {
                sessionDebt[id]--;
                const msg = sessionDebt[id] === 0 ? labels.messages.markClear : labels.messages.keepGoing.replace('{n}', sessionDebt[id]);
                showPopup(msg);
                if(sessionDebt[id] === 0) sessionDeck = sessionDeck.filter(c => c.id !== id);
            } else {
                sessionDeck = sessionDeck.filter(c => c.id !== id);
                showPopup(labels.messages.pass);
            }
            pickRandomCard();
        }

        function handleMastered() {
            if (!masteredIds.includes(currentCard.id)) {
                masteredIds.push(currentCard.id);
                saveData();
            }
            sessionDeck = sessionDeck.filter(c => c.id !== currentCard.id);
            showPopup(labels.messages.addedMaster);
            pickRandomCard();
        }

        function toggleBookmark(e) {
            e.stopPropagation();
            const id = currentCard.id;
            if (bookmarkedIds.includes(id)) {
                bookmarkedIds = bookmarkedIds.filter(bid => bid !== id);
                showPopup(labels.messages.removedBookmark);
            } else {
                bookmarkedIds.push(id);
                showPopup(labels.messages.addedBookmark);
            }
            saveData();
            updateCardUI();
        }

        function unMaster(id) {
            if(confirm(labels.messages.confirmUnMaster)) {
                masteredIds = masteredIds.filter(mid => mid !== id);
                saveData();
                showMasteredScreen();
                showPopup(labels.messages.movedBack);
            }
        }

        function resetProgress() {
            if(confirm(labels.messages.confirmReset)) {
                masteredIds = []; bookmarkedIds = [];
                saveData();
                location.reload();
            }
        }

        function showPopup(msg) {
            const modal = document.getElementById('msg-modal');
            document.getElementById('msg-content').innerText = msg;
            modal.style.display = 'flex';
        }
        function closePopup() { document.getElementById('msg-modal').style.display = 'none'; }

        function pickRandomCard() {
            if (sessionDeck.length === 0) { showPopup(labels.messages.complete); goBackToLobby(); return; }
            let nextIndex = 0;
            if (sessionDeck.length > 1 && currentCard) {
                do { nextIndex = Math.floor(Math.random() * sessionDeck.length); } while (sessionDeck[nextIndex].id === currentCard.id);
            }
            currentCard = sessionDeck[nextIndex];
            updateCardUI();
        }

        function updateCardUI() {
            const cardEl = document.getElementById('flashcard');
            cardEl.classList.remove('flipped');
            document.getElementById('remain-count').innerText = sessionDeck.length;

            setTimeout(() => {
                document.getElementById('term-zh').innerText = currentCard.zh;
                document.getElementById('term-ja').innerText = currentCard.ja;
                document.getElementById('term-yomi').innerText = currentCard.yomi || '';
                document.getElementById('term-eng').innerText = currentCard.eng || '';
                document.getElementById('desc-zh').innerText = currentCard.desc_zh;
                document.getElementById('desc-ja').innerText = currentCard.desc_ja;

                const star = document.getElementById('bookmark-icon');
                star.className = bookmarkedIds.includes(currentCard.id) ? 'card-icon active' : 'card-icon';
                
                const debt = sessionDebt[currentCard.id] || 0;
                const badge = document.getElementById('debt-badge');
                badge.style.display = debt > 0 ? 'block' : 'none';
            }, 200);
        }

        function saveData() {
            localStorage.setItem('fe_mastered', JSON.stringify(masteredIds));
            localStorage.setItem('fe_bookmarked', JSON.stringify(bookmarkedIds));
            renderLobby();
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
